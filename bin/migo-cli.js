// Generated by ToffeeScript 1.6.3-4
(function() {
  var VERSION, conf, data, err, fs, m, migo, migoFile, ok, opt, targetVersion, _ref,
    _this = this;

  fs = require('fs');

  migo = require('..');

  ok = migo.ok;

  VERSION = '0.1.4';

  opt = require('node-getopt').create([['c', 'conf=CONFFILE', 'configure file'], ['h', 'help']]).bindHelp("migo v" + VERSION + " - PostgreSQL Database Migration\n\nUsage:\n  migo.js [OPTION] MIGOFILE [VERSION]\n\nOptions:\n[[OPTIONS]]\n\nFiles:\n  foo.migo       MIGOFILE file\n  $MIGOFILE.id   migration version\n  $MIGOFILE.conf CONFFILE default configure file\n\nMore help on https://github.com/jiangmiao/migo").parseSystem();

  if (opt.argv.length === 0) {
    opt.showHelp();
    process.exit(1);
  }

  _ref = opt.argv, migoFile = _ref[0], targetVersion = _ref[1];

  conf = opt.options.conf;

  if (conf == null) {
    conf = migoFile + '.conf';
  }

  fs.readFile(conf, 'UTF-8', function() {
    err = arguments[0], data = arguments[1];
    ok(err);
    conf = {};
    data.replace(/^(.*?)=(.*)/mg, function(_, k, v) {
      k = k.trim();
      v = v.trim();
      return conf[k] = v;
    });
    m = migo.init(conf);
    m.parseFile(migoFile, function() {
      m.migrate(targetVersion, function() {
        return migo.close();
      });
    });
  });

}).call(this);
